ğŸ‰ *Bienvenue {mention} dans le groupe* *Q\\&R Malikiyyah* \\! ğŸŠ

ğŸ“Œ *__Comment poser une question__ \\?*
\\#NÂ° \\[suivre l'ordre\\] \\+ NÂ° \\[suivre l'ordre du jour\\] \\+ Question
Exemple : \\#625 1 L'urine de bÃ©bÃ© est\\-elle impure \\?

ğŸ“Œ *__OBJECTIF DU GROUPE__* :
Trouver des rÃ©ponses Ã  vos questions de fiqh, de 'aqiidah et de tasawwuf touchant Ã  votre pratique\\.

âš ï¸ Ce groupe *nâ€™est pas un substitut* Ã  lâ€™apprentissage de votre religion\\.
ğŸ“Œ **[Pour suivre des cours cliquez ici](https://www.notion.so/majlisalfatih/Cours-574a6ea54b2d4134b18a7d362ca7d00f)**

ğŸ“Œ *__Qui rÃ©pond aux questions ici__ \\?*

â€¢ **Abdullah Mathieu Gallant**
â€¢ **Saifoullah Abu Muhammad**
â€¢ **Admin\\(s\\) \\( @ibtisaamou pour les sÅ“urs \\)**

ğŸ“Œ **[Pour connaÃ®tre leur cursus, leurs shuyuukh, clique ici](https://www.notion.so/majlisalfatih/46691c76bd6e441483fcdd211d5880df?v=ec736494d7cd446783c655cb0dbb6e58)**

Ils sont tous deux des Ã©tudiants avancÃ©s en sciences islamiques qui ont l'autorisation de leurs shuyÃ»kh pour enseigner et rÃ©pondre aux questions, mais ils ne pourront pas avoir rÃ©ponse Ã  tout\\.

S'ils ne connaissent pas la rÃ©ponse, vous serez redirigÃ©s vers un mufti francophone\\.

ğŸ“Œ **[ğŸ”— Rejoindre le groupe Q\\&R Malikiyyah](https://t.me/+ZBL9frEFpvYyNThh)**

ğŸ“Œ *__RÃˆGLES DU GROUPE__*

    â€¢ âš ï¸ *Une seule question par membre par jour* âš ï¸
    â€¢ âš ï¸ *__NUMÃ‰ROTEZ VOS QUESTIONS SVP__* âš ï¸
â€¢ Les enseignants ont besoin de faire des recherches pour certaines questions, aussi par respect nous vous demandons de ne pas les relancer systÃ©matiquement mais de patienter 24h avant de le faire\\.
    â€¢ Pas de questions thÃ©oriques sans application pratique \\(ex\\. hukm de manger de la sirÃ¨ne\\)\\.
    â€¢ Vous pouvez demander des prÃ©cisions si la rÃ©ponse donnÃ©e n'est pas claire, mais Ã©vitez de demander le raison d'Ãªtre et les preuves des statuts juridiques\\.
    â€¢ **__Interdit de partager les rÃ©ponses sans permission__**
    â€¢ Pas de dÃ©bats ni dâ€™Ã©changes entre les membres\\.
    â€¢ Il n'est pas permis de rÃ©pondre Ã  la place des admins\\.

âš ï¸ *__Non respect \\= EXPULSION__*

ğŸ“Œ *__Ã€ TITRE INFORMATIF__*

ğŸ“Œ **Veuillez vous adresser Ã  [l'IFI](https://institut-francophone-iftaa.com/question)** si vous avez besoin d'une fatwa\\.
â€¢ *Pas de rÃ©ponse aux questions sensibles, les envoyez Ã  * @questionsprivees

ğŸ“Œ **âœ… {mention}, pour continuer, veuillez cliquer sur "accepter"\\.**
"""







######################  daily msg  ######################

async def send_daily_message(context: CallbackContext):
    """Envoie un message quotidien Ã  00h01."""
    message = (
        "Nous nous retrouvons ce jour par la GrÃ¢ce d'Allah dans Q&R MALIKIYYAH, "
        "groupe dÃ©diÃ© aux questions pratiques de fiqh, de 'aqiidah et de tasawwuf de la communautÃ© musulmane â­ï¸\n\n"
        "ğŸ“Œ **RAPPEL GÃ‰NÃ‰RAL** ğŸ“Œ\n\n"

        "â–ªï¸ Respectez les [rÃ¨gles du groupe](https://t.me/c/1912372093/7898) \n"
        "â–ªï¸ Et surtout : Ã©tudiez la Science !\n"
        "ğŸ‘‰ Remplissez cette obligation en suivant [des cours](https://majlisalfatih.weebly.com/cours.html)\n\n"
        "Baraak Allaahu fiikum !"
    )

    try:
        await context.bot.send_message(chat_id=CHAT_ID, text=message, parse_mode="Markdown")
        logging.info("âœ… Message quotidien envoyÃ© avec succÃ¨s.")
    except Exception as e:
        logging.error(f"âŒ Erreur lors de l'envoi du message quotidien : {e}")

# â³ Planifier l'envoi du message Ã  00h01 tous les jours
aiocron.crontab('1 0 * * *', func=send_daily_message, args=[None])



####################################

####################################


async def check_question_number(update: Update, context: CallbackContext) -> None:
    """VÃ©rifie si un message contient un numÃ©ro de question valide (#XXX) et suit l'ordre strict."""

    if not update.message:
        return

    user = update.message.from_user
    message_text = update.message.text.strip()  # Supprimer les espaces inutiles
    chat_id = update.message.chat_id
    mention = get_mention(user)
    user_id = user.id
    current_time = time.time()

    # âœ… Ignorer si c'est une rÃ©ponse Ã  un autre message
    if update.message.reply_to_message:
        return

    # âœ… VÃ©rifier si l'utilisateur est un simple membre (exclure admins)
    try:
        chat_member = await context.bot.get_chat_member(chat_id, user_id)
        if chat_member.status != "member":
            return  # Ignorer les admins et autres rÃ´les
    except Exception as e:
        logging.error(f"âŒ Erreur lors de la vÃ©rification du statut pour {user_id} : {e}")
        return

    # âœ… VÃ©rifier si l'utilisateur a rÃ©cemment posÃ© une question (moins de 15 min)
    last_time = user_last_question_time.get(user_id, 0)
    if current_time - last_time < 1:  # â³ 15 minutes = 900 secondes
        return  # Ignorer les messages de cet utilisateur s'il a dÃ©jÃ  posÃ© une question rÃ©cemment

    # âœ… VÃ©rifier si un `#` est prÃ©sent dans le message
    match = re.search(r"#(\d+)", message_text)

    if not match:
        last_number = last_question_number.get(chat_id, 0)
        expected_number = last_number + 1

        # ğŸ”´ Correction : IncrÃ©menter immÃ©diatement pour Ã©viter les conflits
        last_question_number[chat_id] = expected_number

        await update.message.reply_text(
            f"{mention} Veuillez inclure un numÃ©ro de question avec #{expected_number}."

        )
        return

    # âœ… Extraire le numÃ©ro de la question
    question_number = int(match.group(1))

    # âœ… RÃ©cupÃ©rer le dernier numÃ©ro de question pour ce chat
    last_number = last_question_number.get(chat_id, 0)
    expected_number = last_number + 1

    # âœ… VÃ©rifier si le bot dÃ©marre en cours de route (ex: le groupe est dÃ©jÃ  Ã  #1400)
    if chat_id not in last_question_number:
        last_question_number[chat_id] = question_number
        user_last_question_time[user_id] = current_time
        return

    # âœ… VÃ©rifier que la numÃ©rotation suit bien lâ€™ordre sÃ©quentiel
    if question_number < expected_number:
        await update.message.reply_text(
            f"{mention} Ce numÃ©ro est dÃ©jÃ  utilisÃ©. Veuillez utiliser #{expected_number}."
        )
        return

    if question_number > expected_number:
        await update.message.reply_text(
            f"{mention} Vous avez sautÃ© des numÃ©ros ! Le bon numÃ©ro est #{expected_number}."
        )
        # ğŸ”´ On incrÃ©mente directement le dernier numÃ©ro pour Ã©viter les conflits
        last_question_number[chat_id] += 1
        return

    # âœ… Mettre Ã  jour avec le dernier numÃ©ro
    last_question_number[chat_id] = question_number
    user_last_question_time[user_id] = current_time  # Mise Ã  jour du timestamp utilisateur

    await check_and_close_group(update, context)  # VÃ©rifier si la limite de 10 questions est atteinte

**********************************************************
async def initialize_last_question_number(context: CallbackContext, chat_id: int):
    """RÃ©cupÃ¨re le dernier numÃ©ro #XXX trouvÃ© dans le groupe, en prenant le plus grand dans les 50 derniers messages."""
    try:
        last_valid_number = 0  # âœ… On commence avec 0 et on cherche le plus grand numÃ©ro

        async for message in context.bot.get_chat(chat_id).get_history(limit=50):  # ğŸ”¹ On rÃ©cupÃ¨re les 50 derniers messages
            if message.text:
                match = re.search(r"#(\d+)", message.text)
                if match:
                    num = int(match.group(1))
                    last_valid_number = max(last_valid_number, num)  # âœ… On garde toujours le plus grand trouvÃ©

        last_question_number[chat_id] = last_valid_number  # âœ… Mise Ã  jour avec le dernier numÃ©ro correct
        logging.info(f"âœ… Initialisation : dernier numÃ©ro trouvÃ© dans {chat_id} â†’ #{last_question_number[chat_id]}")

    except Exception as e:
        logging.error(f"âŒ Erreur lors de l'initialisation de last_question_number pour {chat_id} : {e}")
        last_question_number[chat_id] = 0  # SÃ©curitÃ© en cas d'erreur
**********************************************************